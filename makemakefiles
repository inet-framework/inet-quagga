#
# Makefile to create all other makefiles for the project.
#
# CAREFUL: This file has to remain portable across Unix make and Windows nmake!
#

# The vars ROOT, MAKEMAKE and EXT have to be specified externally, on the 'make' command line.
#ROOT=d:/home/IPv6SuiteWithINET
#MAKEMAKE=opp_nmakemake
#EXT=.vc

# for compiled-in NED files, remove -N from OPTS, and switch to the longer version of ALL_MODEL_OPTS below
# with omnetpp-3.2 or newer, if you want to build windows dlls, add this to OPTS below: -PINET_API
OPTS=-f -N -b $(ROOT) -c $(ROOT)/inetconfig$(EXT) -I.

CONTRACT_INCLUDES=-I$(ROOT)/Src/Transport/Contract -I$(ROOT)/Src/Network/Contract -I$(ROOT)/Src/NetworkInterfaces/Contract -I$(ROOT)/Src/Base -I$(ROOT)/Src/Util

ALL_INET_INCLUDES=$(CONTRACT_INCLUDES) -I$(ROOT)/Src/Network/IPv4 -I$(ROOT)/Src/Network/AutoRouting -I$(ROOT)/Src/Network/Queue -I$(ROOT)/Src/Network/OSPFv2 -I$(ROOT)/Src/Network/OSPFv2/Interface -I$(ROOT)/Src/Network/OSPFv2/MessageHandler -I$(ROOT)/Src/Network/OSPFv2/Neighbor -I$(ROOT)/Src/Network/OSPFv2/Router -I$(ROOT)/Src/Transport/TCP -I$(ROOT)/Src/Transport/TCP/flavours -I$(ROOT)/Src/Transport/TCP/queues -I$(ROOT)/Src/Transport/UDP -I$(ROOT)/Src/NetworkInterfaces -I$(ROOT)/Src/Network/ARP -I$(ROOT)/Src/NetworkInterfaces/Ethernet -I$(ROOT)/Src/NetworkInterfaces/EtherSwitch -I$(ROOT)/Src/NetworkInterfaces/PPP -I$(ROOT)/Src/Applications/Generic -I$(ROOT)/Src/Applications/Ethernet -I$(ROOT)/Src/Applications/TCPApp -I$(ROOT)/Src/Applications/UDPApp -I$(ROOT)/Src/Applications/PingApp -I$(ROOT)/Src/Util/HeaderSerializers -I$(ROOT)/Src/Nodes/INET -I$(ROOT)/Src/Nodes/Wireless -I$(ROOT)/Src/Nodes/Adhoc

# -I$(ROOT)/Src/Applications/BRModel
ALL_MPLS_INCLUDES=-I$(ROOT)/Src/Network/MPLS -I$(ROOT)/Src/Network/LDP -I$(ROOT)/Src/Network/RSVP_TE -I$(ROOT)/Src/Network/TED -I$(ROOT)/Src/Network/Extras -I$(ROOT)/Src/Nodes/MPLS
ALL_IPv6_INCLUDES=-I$(ROOT)/Src/Network/IPv6 -I$(ROOT)/Src/Network/ICMPv6 -I$(ROOT)/Src/Nodes/IPv6
ALL_MF_INCLUDES=-I$(ROOT)/Src/World -I$(ROOT)/Src/Mobility -I$(ROOT)/Src/NetworkInterfaces/MFCore -I$(ROOT)/Src/NetworkInterfaces/MF80211 -I$(ROOT)/Src/NetworkInterfaces/MF80211/macLayer -I$(ROOT)/Src/NetworkInterfaces/MF80211/phyLayer -I$(ROOT)/Src/NetworkInterfaces/MF80211/phyLayer/decider -I$(ROOT)/Src/NetworkInterfaces/MF80211/phyLayer/snrEval -I$(ROOT)/Src/NetworkInterfaces/Ieee80211 -I$(ROOT)/Src/NetworkInterfaces/Ieee80211/Mac -I$(ROOT)/Src/NetworkInterfaces/Ieee80211/Mgmt -I$(ROOT)/Src/NetworkInterfaces/Radio
QUAGGA_INCLUDES=-I$(ROOT)/Src/Network/Quagga -I$(ROOT)/Src/Network/Quagga/UnitTest

#ALL_MODEL_OPTS=$(OPTS) -w $(ALL_INET_INCLUDES) $(ALL_MPLS_INCLUDES) $(ALL_IPv6_INCLUDES)
ALL_MODEL_OPTS=$(OPTS) -n

#
# Example simulations don't contain C++ code, only NED, ini and other config
# files, so they don't need Makefiles. They all invoke the bin/INET executable.
#

all: inetbase

inetbase:
	$(MAKEMAKE) $(OPTS) -n -r -X Documentation -X Etc -X Examples -X Tests -X Experimental -X Obsolete -X tmp

	cd bin && $(MAKEMAKE) $(OPTS) -w -o INET $(ALL_INET_INCLUDES) $(ALL_IPv6_INCLUDES) $(ALL_MPLS_INCLUDES) $(ALL_MF_INCLUDES)
	: # $(QUAGGA_INCLUDES)

	cd Src && $(MAKEMAKE) $(OPTS) -n -r
	cd Src/Applications && $(MAKEMAKE) $(OPTS) -n -r
	cd Src/Network && $(MAKEMAKE) $(OPTS) -n -r -X Quagga
	cd Src/NetworkInterfaces && $(MAKEMAKE) $(OPTS) -n -r
	cd Src/Nodes && $(MAKEMAKE) $(OPTS) -n -r
	cd Src/Transport && $(MAKEMAKE) $(OPTS) -n -r -X RTP
	cd Src/Base && $(MAKEMAKE) $(OPTS) -n -r -I../Util
	cd Src/Util && $(MAKEMAKE) $(OPTS) -n -r $(ALL_INET_INCLUDES) $(ALL_IPv6_INCLUDES) $(ALL_MPLS_INCLUDES) $(ALL_MF_INCLUDES)

	: # MF stuff follows
	cd Src/World && $(MAKEMAKE) $(OPTS) -n -r -I../Util -I../Base
	cd Src/Mobility && $(MAKEMAKE) $(OPTS) -n -r -I../Util -I../Base -I../World
	cd Src/NetworkInterfaces/MFCore && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../../World
	cd Src/NetworkInterfaces/MF80211 && $(MAKEMAKE) $(OPTS) -n -r
	cd Src/NetworkInterfaces/MF80211/macLayer && $(MAKEMAKE) $(OPTS) -n $(CONTRACT_INCLUDES) -I../../MFCore -I../phyLayer/snrEval
	cd Src/NetworkInterfaces/MF80211/phyLayer && $(MAKEMAKE) $(OPTS) -n -r
	cd Src/NetworkInterfaces/MF80211/phyLayer/decider && $(MAKEMAKE) $(OPTS) -n $(CONTRACT_INCLUDES) -I../../../MFCore -I../../macLayer
	cd Src/NetworkInterfaces/MF80211/phyLayer/snrEval && $(MAKEMAKE) $(OPTS) -n $(CONTRACT_INCLUDES) -I../../../MFCore -I../../macLayer -I../../../../World
	cd Src/NetworkInterfaces/Ieee80211 && $(MAKEMAKE) $(OPTS) -n -r
	cd Src/NetworkInterfaces/Ieee80211/Mac && $(MAKEMAKE) $(OPTS) -n $(CONTRACT_INCLUDES) -I../../MFCore
	cd Src/NetworkInterfaces/Ieee80211/Mgmt && $(MAKEMAKE) $(OPTS) -n $(CONTRACT_INCLUDES) -I../Mac -I../../Ethernet
	cd Src/NetworkInterfaces/Radio && $(MAKEMAKE) $(OPTS) -n -n $(CONTRACT_INCLUDES) -I../MFCore -I../Ieee80211/Mac -I../../World

	cd Src/Nodes/IPv6 && $(MAKEMAKE) $(OPTS) -n -r $(ALL_INET_INCLUDES) $(ALL_IPv6_INCLUDES)

	cd Src/Applications/Generic && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES)
	cd Src/Applications/Ethernet && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../../NetworkInterfaces/Ethernet
	cd Src/Applications/PingApp && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES)
	cd Src/Applications/TCPApp && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../../Transport/TCP
	cd Src/Applications/UDPApp && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES)

	cd Src/Network/Contract && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../IPv4 -I../IPv6 -I../ICMPv6
	cd Src/Network/IPv4 && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../ARP
	cd Src/Network/Queue && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../IPv4 -I../IPv6
	cd Src/Network/ARP && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../IPv4
	cd Src/Network/AutoRouting && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../IPv4 -I../IPv6 -I../ICMPv6
	cd Src/Network/IPv6 && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../ICMPv6
	cd Src/Network/ICMPv6 && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../IPv6

	: # FIXME reduce cross-dependency among MPLS, LDP, TED and RSVP_TE!
	cd Src/Network/MPLS && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../IPv4 -I../RSVP_TE -I../LDP -I../../Transport/TCP
	cd Src/Network/LDP && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../MPLS -I../IPv4 -I../TED -I../RSVP_TE -I../../Transport/UDP -I../../Transport/TCP
	cd Src/Network/RSVP_TE && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../MPLS -I../IPv4 -I../TED
	cd Src/Network/TED && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../MPLS -I../IPv4 -I../RSVP_TE
	cd Src/Network/Extras && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES)
	cd Src/Network/Quagga && $(MAKEMAKE) $(OPTS) -n -r $(ALL_MPLS_INCLUDES) $(ALL_INET_INCLUDES) $(ALL_MF_INCLUDES)
	cd Src/Network/Quagga/UnitTest && $(MAKEMAKE) $(OPTS) -n -r $(ALL_MPLS_INCLUDES) $(ALL_INET_INCLUDES) $(ALL_MF_INCLUDES)

	cd Src/Network/OSPFv2 && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I. -I../IPv4 -IRouter -IInterface -IMessageHandler -INeighbor
	cd Src/Network/OSPFv2/Interface && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I. -I.. -I../../IPv4 -I../Neighbor -I../Router -I../MessageHandler
	cd Src/Network/OSPFv2/MessageHandler && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I. -I.. -I../../IPv4 -I../Interface -I../Neighbor -I../Router
	cd Src/Network/OSPFv2/Neighbor && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I. -I.. -I../../IPv4 -I../MessageHandler -I../Interface -I../Router
	cd Src/Network/OSPFv2/Router && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I. -I.. -I../../IPv4 -I../MessageHandler -I../Interface -I../Neighbor

	cd Src/NetworkInterfaces/Contract && $(MAKEMAKE) $(OPTS) -n $(CONTRACT_INCLUDES)
	cd Src/NetworkInterfaces/PPP && $(MAKEMAKE) $(OPTS) -n $(CONTRACT_INCLUDES) -I../../Network/Queue
	cd Src/NetworkInterfaces/Ethernet && $(MAKEMAKE) $(OPTS) -n $(CONTRACT_INCLUDES) -I../../Network/Queue
	cd Src/NetworkInterfaces/EtherSwitch && $(MAKEMAKE) $(OPTS) -n $(CONTRACT_INCLUDES) -I../Ethernet

	cd Src/Nodes/INET && $(MAKEMAKE) $(OPTS) -n -r $(ALL_INET_INCLUDES)
	cd Src/Nodes/IPv6 && $(MAKEMAKE) $(OPTS) -n -r $(ALL_INET_INCLUDES)
	cd Src/Nodes/Wireless && $(MAKEMAKE) $(OPTS) -n -r $(ALL_INET_INCLUDES)
	cd Src/Nodes/Adhoc && $(MAKEMAKE) $(OPTS) -n -r $(ALL_INET_INCLUDES)
	cd Src/Nodes/MPLS && $(MAKEMAKE) $(OPTS) -n -r $(ALL_INET_INCLUDES) $(ALL_MPLS_INCLUDES)

	cd Src/Transport/Contract && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES)
	cd Src/Transport/UDP && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../../Network/IPv4 -I../../Network/ICMPv6 -I../../Network/IPv6
	cd Src/Transport/RTP && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -X Profiles -X tmp
	cd Src/Transport/TCP && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I../../Network/IPv4 -I../../Network/ICMPv6 -I../../Network/IPv6
	cd Src/Transport/TCP/flavours && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I..
	cd Src/Transport/TCP/queues && $(MAKEMAKE) $(OPTS) -n -r $(CONTRACT_INCLUDES) -I..

	cd Src/Util/HeaderSerializers && $(MAKEMAKE) $(OPTS) -n $(ALL_INET_INCLUDES) $(ALL_IPv6_INCLUDES) $(ALL_MPLS_INCLUDES) $(ALL_MF_INCLUDES)

# UNUSED TARGET. It might only be needed with fully compiled-in NED files, or when
# an example simulation contains C++ parts too (currently none have).
examples-dir:
	cd Examples && $(MAKEMAKE) $(OPTS) -n -r
	cd Examples/Ethernet && $(MAKEMAKE) $(OPTS) -n -r
	cd Examples/INET && $(MAKEMAKE) $(OPTS) -n -r
	cd Examples/OSPFv2 && $(MAKEMAKE) $(OPTS) -n -r
	cd Examples/Quagga && $(MAKEMAKE) $(OPTS) -n -r
	cd Examples/MPLS && $(MAKEMAKE) $(OPTS) -n -r
	cd Examples/IPv6 && $(MAKEMAKE) $(OPTS) -n -r
	cd Examples/RTP && $(MAKEMAKE) $(OPTS) -n -r -X Data -X Multicast1 -X Multicast2 -X Unicast
	cd Examples/Wireless && $(MAKEMAKE) $(OPTS) -n -r
	cd Examples/Adhoc && $(MAKEMAKE) $(OPTS) -n -r

	cd Examples/Ethernet/ARPTest && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/Ethernet/ARPTest2 && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/Ethernet/LANs && $(MAKEMAKE) $(ALL_MODEL_OPTS)

	cd Examples/INET/NClients && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/INET/FlatNet && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/INET/KIDSNw1 && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/INET/Multicast && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/INET/RouterPerf && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/INET/BulkTransfer && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/INET/REDTest && $(MAKEMAKE) $(ALL_MODEL_OPTS)

	cd Examples/OSPFv2/Areas && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/OSPFv2/Backbone && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/OSPFv2/FullTest && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/OSPFv2/SimpleTest && $(MAKEMAKE) $(ALL_MODEL_OPTS)

	cd Examples/Quagga/FourRouters && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/Quagga/SimpleTest && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/Quagga/OSPFBackbone && $(MAKEMAKE) $(ALL_MODEL_OPTS)

	cd Examples/MPLS/LDP && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/MPLS/Net37 && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/MPLS/TestTE_Failure && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	: #cd Examples/MPLS/TestTE_Failure2 && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/MPLS/TestTE_Reroute && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/MPLS/TestTE_Routing && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/MPLS/TestTE_Tunnel  && $(MAKEMAKE) $(ALL_MODEL_OPTS)

	cd Examples/IPv6/NClients && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/IPv6/DemoNetworkEth && $(MAKEMAKE) $(ALL_MODEL_OPTS)

	cd Examples/Wireless/80211Lan && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/Wireless/Handover && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/Wireless/Throughput && $(MAKEMAKE) $(ALL_MODEL_OPTS)

	cd Examples/Adhoc/Mobility && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/Adhoc/Ieee80211 && $(MAKEMAKE) $(ALL_MODEL_OPTS)
	cd Examples/Adhoc/MF80211 && $(MAKEMAKE) $(ALL_MODEL_OPTS)

tests-dir:
	cd Tests && $(MAKEMAKE) $(OPTS) -n -r -X IPv4 -X MPLS
	cd Tests/NewTCP && $(MAKEMAKE) $(OPTS) -w $(ALL_INET_INCLUDES) $(ALL_IPv6_INCLUDES)

